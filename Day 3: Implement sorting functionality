#include <bits/stdc++.h>
using namespace std;


struct ProcInfo3{int pid; string name; unsigned long cpu_ticks; long rss_kb;};


vector<ProcInfo3> get_procs(){
vector<ProcInfo3> out;
DIR *d = opendir("/proc"); if(!d) return out; struct dirent *e;
while((e = readdir(d))){ if(e->d_type!=DT_DIR) continue; string s = e->d_name; if(!all_of(s.begin(), s.end(), ::isdigit)) continue; int pid = stoi(s);
string statpath = "/proc/"+s+"/stat"; ifstream fs(statpath); if(!fs) continue; string line; getline(fs,line);
size_t p1 = line.find('('), p2 = line.rfind(')'); string comm = (p1!=string::npos && p2!=string::npos)? line.substr(p1+1,p2-p1-1):""; string after = line.substr(p2+2);
stringstream ss(after); vector<string> toks; string t; while(ss>>t) toks.push_back(t);
unsigned long utime=0, stime=0; long rss_pages=0; if(toks.size()>=15){ utime = stoul(toks[13]); stime = stoul(toks[14]); if(toks.size()>=23) rss_pages = stol(toks[21]); }
long page_kb = sysconf(_SC_PAGESIZE)/1024; long rss_kb = rss_pages * page_kb;
out.push_back({pid, comm, utime+stime, rss_kb});
}
closedir(d); return out;
}


int main(int argc, char** argv){
string sortby = "cpu"; // default
for(int i=1;i<argc;i++){
string a = argv[i]; if(a.rfind("--sort=",0)==0) sortby = a.substr(7);
}
auto procs = get_procs();
if(sortby=="cpu") sort(procs.begin(), procs.end(), [](auto &a, auto &b){ return a.cpu_ticks>b.cpu_ticks; });
else if(sortby=="mem") sort(procs.begin(), procs.end(), [](auto &a, auto &b){ return a.rss_kb>b.rss_kb; });
cout<<"Day3 - Sorted process list (sort="<<sortby<<")\n";
cout<<left<<setw(8)<<"PID"<<setw(30)<<"NAME"<<setw(12)<<"CPU_TICKS"<<setw(12)<<"RSS_kB"<<"\n";
for(size_t i=0;i<min<size_t>(procs.size(),100);++i){ auto &p = procs[i]; cout<<left<<setw(8)<<p.pid<<setw(30)<<p.name<<setw(12)<<p.cpu_ticks<<setw(12)<<p.rss_kb<<"\n"; }
cout<<"\nTotal: "<<procs.size()<<"\n";
return 0;
}
